# ACR triggered pipeline based on dev* tag. Imports app configuration and deploys container to two dev app services.

trigger:
  - none # Disable trigger on the repository itself

# Trigger from container registry
resources:
  containers:
  - container: YOUR REF
    type: ACR  
    azureSubscription: YOUR SERVICE CONNECTION
    resourceGroup: YOUR RESOURCE GROUP
    registry: YOUR REGISTRY
    repository: YOUR REPO
    trigger:
      tags:
        include:
        - dev*

variables:
- name: SourceRegistryName
  value: $(resources.container.YOUR REF.registry)
- name: Repository
  value: $(resources.container.YOUR REF.repository)
- name: Tag
  value: $(resources.container.YOUR REF.tag)
- group: shared-vars

stages:
  - stage: Dev
    displayName: Dev
    jobs:
      # Track deployments on the environment.
    - deployment: DeployContainers
      displayName: Deploy Containers
      pool:
        vmimage: ubuntu-latest
      # Creates an environment if it doesn't exist.
      environment: '$(AppName)-Dev'
      strategy:
        runOnce:
          deploy:
            steps:
            - checkout: self
            - task: AzureCLI@2
              displayName: Dev Main App Config
              inputs:
                azureSubscription: '$(NonProdServiceConnectionName)'
                scriptType: 'bash'
                scriptLocation: 'inlineScript'
                inlineScript: |
                  ID=$(az webapp show --name 'app-$(AppShortName)-uks-dev-001' --resource-group 'rg-$(AppShortName)-dev-001' --query id --output tsv) 
                  az appconfig kv export --connection-string '$(AppConfigConnectionString)' --destination appservice --label 'Dev' --yes --appservice-account $ID
            - task: AzureRmWebAppDeployment@4
              displayName: Web App Deploy
              inputs:
                ConnectionType: 'AzureRM'
                azureSubscription: '$(NonProdServiceConnectionName)'
                appType: 'webAppContainer'
                WebAppName: 'app-$(AppShortName)-uks-dev-001'
                DockerNamespace: '$(NonProdAcrName).azurecr.io'
                DockerRepository: '$(Repository)'
                DockerImageTag: '$(Tag)'
                AppSettings: '-DOCKER_REGISTRY_SERVER_URL https://$(NonProdAcrName).azurecr.io -DOCKER_REGISTRY_SERVER_USERNAME $(NonProdAcrUsername) -DOCKER_REGISTRY_SERVER_PASSWORD $(NonProdAcrPassword)'
            - task: AzureAppServiceManage@0
              displayName: Restart Web App
              inputs:
                azureSubscription: '$(NonProdServiceConnectionName)'
                Action: 'Restart Azure App Service'
                WebAppName: 'app-$(AppShortName)-uks-dev-001'
            - task: AzureCLI@2
              displayName: Dev BG App Config
              inputs:
                azureSubscription: '$(NonProdServiceConnectionName)'
                scriptType: 'bash'
                scriptLocation: 'inlineScript'
                inlineScript: |
                  ID=$(az webapp show --name 'app-$(AppShortName)-bg-uks-dev-001' --resource-group 'rg-$(AppShortName)-dev-001' --query id --output tsv) 
                  az appconfig kv export --connection-string '$(AppConfigConnectionString)' --destination appservice --label 'Dev' --yes --appservice-account $ID
            - task: AzureRmWebAppDeployment@4
              displayName: BG App Deploy
              inputs:
                ConnectionType: 'AzureRM'
                azureSubscription: '$(NonProdServiceConnectionName)'
                appType: 'webAppContainer'
                WebAppName: 'app-$(AppShortName)-bg-uks-dev-001'
                DockerNamespace: '$(NonProdAcrName).azurecr.io'
                DockerRepository: '$(Repository)'
                DockerImageTag: '$(Tag)'
                AppSettings: '-DOCKER_REGISTRY_SERVER_URL https://$(NonProdAcrName).azurecr.io -DOCKER_REGISTRY_SERVER_USERNAME $(NonProdAcrUsername) -DOCKER_REGISTRY_SERVER_PASSWORD $(NonProdAcrPassword)'
            - task: AzureAppServiceManage@0
              displayName: Restart BG Web App
              inputs:
                azureSubscription: '$(NonProdServiceConnectionName)'
                Action: 'Restart Azure App Service'
                WebAppName: 'app-$(AppShortName)-bg-uks-dev-001'
